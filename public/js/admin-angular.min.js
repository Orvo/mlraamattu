function nl2br(str,is_xhtml){var breakTag=is_xhtml||"undefined"==typeof is_xhtml?"<br />":"<br>";return(str+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+breakTag+"$2")}!function(a,b){"function"==typeof define&&define.amd?define(["angular"],b):b(angular)}(this,function(a){function b(a){return{restrict:"A",require:["ckeditor","ngModel"],controller:["$scope","$element","$attrs","$parse","$q",c],link:function(b,c,e,f){var g=f[0],h=f[1];g.ready().then(function(){["dataReady","change","blur","saveSnapshot"].forEach(function(a){g.onCKEvent(a,function(){h.$setViewValue(g.instance.getData()||"")})}),g.instance.setReadOnly(!!e.readonly),e.$observe("readonly",function(a){g.instance.setReadOnly(!!a)}),d(function(){a(e.ready)(b)})}),h.$render=function(){g.ready().then(function(){g.instance.setData(h.$viewValue||"",{noSnapshot:!0,callback:function(){g.instance.fire("updateSnapshot")}})})}}}}function c(a,b,c,e,f){var g,h=e(c.ckeditor)(a)||{},i=b[0],j=f.defer();g=i.hasAttribute("contenteditable")&&"true"==i.getAttribute("contenteditable").toLowerCase()?this.instance=CKEDITOR.inline(i,h):this.instance=CKEDITOR.replace(i,h),this.onCKEvent=function(b,c){function e(){var a=arguments;d(function(){f.apply(null,a)})}function f(){var b=arguments;a.$apply(function(){c.apply(null,b)})}return g.on(b,e),function(){g.removeListener(b,f)}},this.onCKEvent("instanceReady",function(){j.resolve(!0)}),this.ready=function(){return j.promise},a.$on("$destroy",function(){j.promise.then(function(){g.destroy(!1)})})}a.module("ckeditor",[]).directive("ckeditor",["$parse",b]);var d=window&&window.setImmediate?window.setImmediate:function(a){setTimeout(a,0)}}),!function(a,b){return"function"==typeof define&&define.amd?void define(["angular","ckeditor"],function(a){return b(a)}):b(a)}(angular||null,function(a){var b,c=a.module("ngCkeditor",[]),d=!1;return c.run(["$q","$timeout",function(c,e){function f(){"loaded"===CKEDITOR.status?(d=!0,b.resolve()):f()}if(b=c.defer(),a.isUndefined(CKEDITOR))throw new Error("CKEDITOR not found");CKEDITOR.disableAutoInline=!0,CKEDITOR.on("loaded",f),e(f,100)}]),c.directive("ckeditor",["$timeout","$q",function(c,e){return{restrict:"AC",require:["ngModel","^?form"],scope:!1,link:function(f,g,h,i){var j=i[0],k=i[1]||null,l="<p></p>",m="textarea"===g[0].tagName.toLowerCase(),n=[],o=!1;m||g.attr("contenteditable",!0);var p=function(){var b={toolbar:"full",toolbar_full:[{name:"basicstyles",items:["Bold","Italic","Strike","Underline"]},{name:"paragraph",items:["BulletedList","NumberedList","Blockquote"]},{name:"editing",items:["JustifyLeft","JustifyCenter","JustifyRight","JustifyBlock"]},{name:"links",items:["Link","Unlink","Anchor"]},{name:"tools",items:["SpellChecker","Maximize"]},"/",{name:"styles",items:["Format","FontSize","TextColor","PasteText","PasteFromWord","RemoveFormat"]},{name:"insert",items:["Image","Table","SpecialChar"]},{name:"forms",items:["Outdent","Indent"]},{name:"clipboard",items:["Undo","Redo"]},{name:"document",items:["PageBreak","Source"]}],disableNativeSpellChecker:!1,uiColor:"#FAFAFA",height:"400px",width:"100%"};b=a.extend(b,f[h.ckeditor]);var d=m?CKEDITOR.replace(g[0],b):CKEDITOR.inline(g[0],b),i=e.defer();g.bind("$destroy",function(){d&&CKEDITOR.instances[d.name]&&CKEDITOR.instances[d.name].destroy()});var p=function(a){var b=d.getData();""===b&&(b=null),c(function(){(a!==!0||b!==j.$viewValue)&&j.$setViewValue(b),a===!0&&k&&k.$setPristine()},0)},q=function(a){if(n.length){var b=n.pop()||l;o=!1,d.setData(b,function(){p(a),o=!0})}};d.on("change",p),d.on("blur",p),d.on("instanceReady",function(){f.$broadcast("ckeditor.ready"),f.$apply(function(){q(!0)}),d.document.on("keyup",p)}),d.on("customConfigLoaded",function(){i.resolve()}),j.$render=function(){n.push(j.$viewValue),o&&q()}};"loaded"===CKEDITOR.status&&(d=!0),d?p():b.promise.then(p)}}}]),c});var elementOnloadDirective=function(){return{restrict:"A",scope:{callback:"&ngOnload"},link:function(e,n,t){var i=n.length>0&&n[0].contentWindow?n[0].contentWindow.location:void 0;n.on("load",function(){return e.callback({contentLocation:i})})}}};elementOnloadDirective.$inject=[],elementOnloadDirective.directiveName="ngOnload",angular.module("ngOnload",[]).directive(elementOnloadDirective.directiveName,elementOnloadDirective),angular.module("ui.sortable",[]).value("uiSortableConfig",{}).directive("uiSortable",["uiSortableConfig","$timeout","$log",function(uiSortableConfig,$timeout,$log){return{require:"?ngModel",scope:{ngModel:"=",uiSortable:"="},link:function(scope,element,attrs,ngModel){function combineCallbacks(first,second){return second&&"function"==typeof second?function(){first.apply(this,arguments),second.apply(this,arguments)}:first}function getSortableWidgetInstance(element){var data=element.data("ui-sortable");return data&&"object"==typeof data&&"ui-sortable"===data.widgetFullName?data:null}function hasSortingHelper(element,ui){var helperOption=element.sortable("option","helper");return"clone"===helperOption||"function"==typeof helperOption&&ui.item.sortable.isCustomHelperUsed()}function isFloating(item){return/left|right/.test(item.css("float"))||/inline|table-cell/.test(item.css("display"))}function getElementScope(elementScopes,element){for(var result=null,i=0;i<elementScopes.length;i++){var x=elementScopes[i];if(x.element[0]===element[0]){result=x.scope;break}}return result}function afterStop(e,ui){ui.item.sortable._destroy()}var savedNodes,opts={},directiveOpts={"ui-floating":void 0},callbacks={receive:null,remove:null,start:null,stop:null,update:null},wrappers={helper:null};return angular.extend(opts,directiveOpts,uiSortableConfig,scope.uiSortable),angular.element.fn&&angular.element.fn.jquery?(ngModel?(scope.$watch("ngModel.length",function(){$timeout(function(){getSortableWidgetInstance(element)&&element.sortable("refresh")},0,!1)}),callbacks.start=function(e,ui){if("auto"===opts["ui-floating"]){var siblings=ui.item.siblings(),sortableWidgetInstance=getSortableWidgetInstance(angular.element(e.target));sortableWidgetInstance.floating=isFloating(siblings)}ui.item.sortable={model:ngModel.$modelValue[ui.item.index()],index:ui.item.index(),source:ui.item.parent(),sourceModel:ngModel.$modelValue,cancel:function(){ui.item.sortable._isCanceled=!0},isCanceled:function(){return ui.item.sortable._isCanceled},isCustomHelperUsed:function(){return!!ui.item.sortable._isCustomHelperUsed},_isCanceled:!1,_isCustomHelperUsed:ui.item.sortable._isCustomHelperUsed,_destroy:function(){angular.forEach(ui.item.sortable,function(value,key){ui.item.sortable[key]=void 0})}}},callbacks.activate=function(e,ui){savedNodes=element.contents();var placeholder=element.sortable("option","placeholder");if(placeholder&&placeholder.element&&"function"==typeof placeholder.element){var phElement=placeholder.element();phElement=angular.element(phElement);var excludes=element.find('[class="'+phElement.attr("class")+'"]:not([ng-repeat], [data-ng-repeat])');savedNodes=savedNodes.not(excludes)}var connectedSortables=ui.item.sortable._connectedSortables||[];connectedSortables.push({element:element,scope:scope}),ui.item.sortable._connectedSortables=connectedSortables},callbacks.update=function(e,ui){if(!ui.item.sortable.received){ui.item.sortable.dropindex=ui.item.index();var droptarget=ui.item.parent();ui.item.sortable.droptarget=droptarget;var droptargetScope=getElementScope(ui.item.sortable._connectedSortables,droptarget);ui.item.sortable.droptargetModel=droptargetScope.ngModel,element.sortable("cancel")}hasSortingHelper(element,ui)&&!ui.item.sortable.received&&"parent"===element.sortable("option","appendTo")&&(savedNodes=savedNodes.not(savedNodes.last())),savedNodes.appendTo(element),ui.item.sortable.received&&(savedNodes=null),ui.item.sortable.received&&!ui.item.sortable.isCanceled()&&scope.$apply(function(){ngModel.$modelValue.splice(ui.item.sortable.dropindex,0,ui.item.sortable.moved)})},callbacks.stop=function(e,ui){!ui.item.sortable.received&&"dropindex"in ui.item.sortable&&!ui.item.sortable.isCanceled()?scope.$apply(function(){ngModel.$modelValue.splice(ui.item.sortable.dropindex,0,ngModel.$modelValue.splice(ui.item.sortable.index,1)[0])}):"dropindex"in ui.item.sortable&&!ui.item.sortable.isCanceled()||hasSortingHelper(element,ui)||savedNodes.appendTo(element),savedNodes=null},callbacks.receive=function(e,ui){ui.item.sortable.received=!0},callbacks.remove=function(e,ui){"dropindex"in ui.item.sortable||(element.sortable("cancel"),ui.item.sortable.cancel()),ui.item.sortable.isCanceled()||scope.$apply(function(){ui.item.sortable.moved=ngModel.$modelValue.splice(ui.item.sortable.index,1)[0]})},wrappers.helper=function(inner){return inner&&"function"==typeof inner?function(e,item){var innerResult=inner.apply(this,arguments);return item.sortable._isCustomHelperUsed=item!==innerResult,innerResult}:inner},scope.$watch("uiSortable",function(newVal){var sortableWidgetInstance=getSortableWidgetInstance(element);sortableWidgetInstance&&angular.forEach(newVal,function(value,key){return key in directiveOpts?("ui-floating"!==key||value!==!1&&value!==!0||(sortableWidgetInstance.floating=value),void(opts[key]=value)):(callbacks[key]?("stop"===key&&(value=combineCallbacks(value,function(){scope.$apply()}),value=combineCallbacks(value,afterStop)),value=combineCallbacks(callbacks[key],value)):wrappers[key]&&(value=wrappers[key](value)),opts[key]=value,void element.sortable("option",key,value))})},!0),angular.forEach(callbacks,function(value,key){opts[key]=combineCallbacks(value,opts[key]),"stop"===key&&(opts[key]=combineCallbacks(opts[key],afterStop))})):$log.info("ui.sortable: ngModel not provided!",element),void element.sortable(opts)):void $log.error("ui.sortable: jQuery should be included before AngularJS!")}}}]);var app=angular.module("adminpanel",["ngResource","ngRoute","ngSanitize","ngOnload","ui.sortable","ckeditor"],function($interpolateProvider){$interpolateProvider.startSymbol("[["),$interpolateProvider.endSymbol("]]")});app.run(function($rootScope,$http){$rootScope.updateUserData=function(){$http.get("/ajax/auth").then(function(response){$rootScope.userData=response.data,$rootScope.userData.lastCheck=Date.now()})}}),app.config(function($routeProvider){var authProvider=function($rootScope,$window,$q,$http){var deferred=$q.defer();return $http.get("/ajax/auth").then(function(response){response.data.authenticated?(deferred.resolve(response.data),$rootScope.userData=response.data,$rootScope.userData.lastCheck=Date.now()):$rootScope.promptLogin({unsavedData:!1,redirectURL:"/auth/login/?ref=admin&route="+$window.location.hash.substr(1),callback:function(){deferred.resolve(response.data),$rootScope.userData=response.data,$rootScope.userData.lastCheck=Date.now()}})},function(response){deferred.reject(!1);var hash=$window.location.hash.substr(1);$window.location.hash="",$window.location="/auth/login/?ref=admin&route="+hash}),deferred.promise};$routeProvider.when("/",{controller:"IndexController",templateUrl:"/ng/index",resolve:{authorization:authProvider}}).when("/courses",{controller:"CoursesController",templateUrl:"/ng/courses.list",resolve:{authorization:authProvider}}).when("/courses/new",{controller:"CoursesFormController",templateUrl:"/ng/courses.form",resolve:{authorization:authProvider}}).when("/courses/:id",{controller:"CourseShowController",templateUrl:"/ng/courses.show",resolve:{authorization:authProvider}}).when("/courses/:id/edit",{controller:"CoursesFormController",templateUrl:"/ng/courses.form",resolve:{authorization:authProvider}}).when("/tests/new/:course_id",{controller:"TestsFormController",templateUrl:"/ng/tests.form",resolve:{authorization:authProvider}}).when("/tests/:id",{controller:"TestsShowController",templateUrl:"/ng/tests.show",resolve:{authorization:authProvider}}).when("/tests/:id/edit",{controller:"TestsFormController",templateUrl:"/ng/tests.form",resolve:{authorization:authProvider}}).when("/users",{controller:"UsersController",templateUrl:"/ng/users.list",resolve:{authorization:authProvider}}).when("/users/new/",{controller:"UsersFormController",templateUrl:"/ng/users.form",resolve:{authorization:authProvider}}).when("/users/:id/edit",{controller:"UsersFormController",templateUrl:"/ng/users.form",resolve:{authorization:authProvider}}).when("/groups",{controller:"GroupsController",templateUrl:"/ng/groups.list",resolve:{authorization:authProvider}}).when("/groups/new/",{controller:"GroupsFormController",templateUrl:"/ng/groups.form",resolve:{authorization:authProvider}}).when("/groups/:id/edit",{controller:"GroupsFormController",templateUrl:"/ng/groups.form",resolve:{authorization:authProvider}}).when("/archive/",{controller:"ArchiveController",templateUrl:"/ng/archive.list",resolve:{authorization:authProvider},reloadOnSearch:!1}).when("/archive/:id/reply",{controller:"ArchiveFormController",templateUrl:"/ng/archive.form",resolve:{authorization:authProvider}}).when("/files/",{controller:"FilesController",templateUrl:"/ng/files",resolve:{authorization:authProvider}}).otherwise({redirectTo:"/",resolve:{authorization:authProvider}})}),app.controller("AjaxLogin",function($rootScope,$scope,$window,$location,$routeParams,$http){$rootScope.promptLogin=function(options,callback){"object"==typeof options?($scope.unsavedData=options.unsavedData,$scope.redirectURL=options.redirectURL,$rootScope.login_callback=options.callback):($scope.unsavedData=options,$rootScope.login_callback=callback),$("#modal-login").modal({show:!0,keyboard:!1,backdrop:"static"})},$scope.do_login=function(){$scope.verifying=!0,$("#modal-login .errors").stop().fadeOut(200),$http.post("/ajax/login",{email:$scope.email,password:$scope.password,remember_me:$scope.remember_me}).then(function(response){$scope.verifying=!1,console.log(response.status,response.data),response.data.success?(response.data.isAdmin||($window.location="/"),$rootScope.userData=response.data,$scope.errors=[],$scope.email="",$scope.password="",$scope.remember_me=!1,$("#modal-login").modal("hide"),$rootScope.login_callback&&$rootScope.login_callback()):($("#modal-login .errors").stop().fadeIn(200),$scope.errors=response.data.errors)},function(response){$scope.verifying=!1,console.log(response.status,response.data)})}}),app.factory("$breadcrumbs",function($rootScope){var list=[],title=!1;return{title:function(title){$rootScope.title=function(){return"function"==typeof title?title():title}},get:function(){return list},reset:function(){list=[],$rootScope.$broadcast("breadcrumb_change"),title=!1,$rootScope.title=!1},segment:function(title,link,loaded){var item={};void 0!==title&&null!==title&&Object.defineProperty(item,"title",{get:function(){return"function"==typeof title?title():title}}),void 0!==link&&null!==link&&Object.defineProperty(item,"link",{get:function(){return"function"==typeof link?link():link}}),void 0!==loaded&&null!==loaded&&Object.defineProperty(item,"loaded",{get:function(){return"function"==typeof loaded?loaded():loaded}}),list.push(item),$rootScope.$broadcast("breadcrumb_change")}}}),app.controller("Breadcrumbs",function($rootScope,$scope,$breadcrumbs){$rootScope.$on("breadcrumb_change",function(){$scope.breadcrumbs=$breadcrumbs.get()})}),app.directive("ngEnter",function(){return function(scope,element,attrs){element.bind("keydown keypress",function(event){13===event.which&&(scope.$apply(function(){scope.$eval(attrs.ngEnter)}),event.preventDefault())})}}),app.directive("elastic",["$timeout",function($timeout){return{restrict:"A",link:function($scope,element){$scope.initialHeight=$scope.initialHeight||element[0].style.height;var resize=function(){element[0].style.height=$scope.initialHeight,element[0].style.height=""+element[0].scrollHeight+"px"};element.on("input change",resize),$timeout(resize,0)}}}]),app.filter("trusted",function($sce){return function(html){return $sce.trustAsHtml(html)}});var question_type_names={CHOICE:"Monivalinta (yksi)",MULTI:"Monivalinta (moni)",TEXT:"Teksti",MULTITEXT:"Moniteksti",TEXTAREA:"Pitkä teksti"},translate_type=function(type){return question_type_names[type]?question_type_names[type]:"Tuntematon tyyppi: "+type},popError=function(data){var pop=window.open("","Error","width=1280,height=720");pop.document.write(data),pop.document.close(),console.log("ERROR",data)},convertToDate=function(timestamp){var t=timestamp.split(/[- :]/);return new Date(t[0],t[1]-1,t[2],t[3],t[4],t[5])};app.controller("NavbarController",function($rootScope,$scope,$window,$location,$routeParams,$http,CoursesModel){$rootScope.update_archive_stats=function(){$http.get("/ajax/archive/stats").then(function(response){$scope.test_records=response.data})},setInterval(function(){$rootScope.update_archive_stats()},3e5),$rootScope.update_archive_stats(),$scope.courses=CoursesModel.query()}),app.filter("archiveSelectFilter",function(){return function(list,settings){var out=[],matchKeys=["discarded","replied_to"];return angular.forEach(list,function(value,key){if(void 0===value.id)out.push(value);else{var hasMatch=!1;for(x in matchKeys){var key_name=matchKeys[x];if(void 0===settings[key_name]||value[key_name]==settings[key_name]){hasMatch=!0;break}}hasMatch&&out.push(value)}}),out}}),app.filter("keyfilter",function(){return function(list,settings){var out=[],resolveObjectKey=function(keypath,object){var tokens=keypath.split("."),value=object;for(var x in tokens)value=value[tokens[x]];return value};return angular.forEach(list,function(value,key){var resolved=resolveObjectKey(settings.key,value);(void 0===settings.value||resolved.toLowerCase().indexOf(settings.value.toLowerCase())>-1)&&out.push(value)}),out}}),app.controller("ArchiveController",function($rootScope,$scope,$window,$location,$routeParams,$filter,$http,$breadcrumbs,$filter,TestsModel,CoursesModel){$breadcrumbs.reset(),$breadcrumbs.segment("Koesuoritukset"),$breadcrumbs.title("Koesuoritukset"),$scope.tests={0:{id:void 0,title:"Rajaa kokeen mukaan"}},$scope.courses={0:{id:void 0,title:"Rajaa kurssin mukaan"}},$http.get("/ajax/archive").then(function(response){response&&(console.log(response.data),$scope.archive=response.data,angular.forEach($scope.archive,function(item,key){item.created_at=convertToDate(item.created_at),item.course_id=parseInt(item.test.course.id),item.replied_to=parseInt(item.replied_to),item.discarded=parseInt(item.discarded),void 0===$scope.tests[item.test.id]&&($scope.tests[item.test.id]=item.test),void 0===$scope.courses[item.test.course.id]&&($scope.courses[item.test.course.id]=item.test.course)}),$location.search().course?($scope.select_filters.course=$scope.courses[$location.search().course],$scope.course_filter_changed()):$location.search().test&&($scope.select_filters.test=$scope.tests[$location.search().test],$scope.test_filter_changed()))});var replied_translate={hide:0,show:1,all:void 0},discarded_translate={hide:0,only:1,show:void 0};$scope.archiveFilter={replied_to:$location.search().replied?replied_translate[$location.search().replied]:0,discarded:$location.search().discarded?discarded_translate[$location.search().discarded]:0},$scope.$watch("searchFilter",function(new_value){var query=$.trim(new_value);$location.search("q",query.length>0?query:void 0);var pattern=/nimi:\"(.*?)\"/,regex_match=query.match(pattern);null!==regex_match?($scope.searchName=$.trim(regex_match[1]),$scope.searchFilterParsed=query.replace(pattern,"")):($scope.searchName="",$scope.searchFilterParsed=query)}),$scope.searchFilter=$location.search().q,$scope.$watch("archiveFilter.replied_to",function(new_value){var translated="";0==new_value&&(translated="hide"),1==new_value&&(translated="show"),void 0===new_value&&(translated="all"),$location.search("replied",translated)}),$scope.$watch("archiveFilter.discarded",function(new_value){var translated="";0==new_value&&(translated="hide"),1==new_value&&(translated="only"),void 0===new_value&&(translated="show"),$location.search("discarded",translated)}),$scope.reset_select_filter=function(no_reset_search){$scope.select_filters={test:$scope.tests[0],course:$scope.courses[0]},$scope.archiveFilter.course_id=void 0,$scope.archiveFilter.test_id=void 0,no_reset_search||($location.search("course",void 0),$location.search("test",void 0))},$scope.reset_select_filter(!0),$scope.course_filter_changed=function(){$scope.archiveFilter.course_id=$scope.select_filters.course.id,$scope.select_filters.test=$scope.tests[0],$scope.archiveFilter.test_id=void 0,$location.search("course",$scope.archiveFilter.course_id),$location.search("test",void 0)},$scope.test_filter_changed=function(){$scope.archiveFilter.test_id=$scope.select_filters.test.id,$scope.archiveFilter.test_id?($scope.select_filters.course=$scope.select_filters.test.course,$scope.archiveFilter.course_id=$scope.select_filters.test.course.id):($scope.select_filters.course=$scope.courses[0],$scope.archiveFilter.course_id=void 0),$location.search("test",$scope.archiveFilter.test_id),$location.search("course",void 0)},$scope.save_success=$rootScope.archiveFeedbackSent,$rootScope.archiveFeedbackSent=!1,$scope.discard=function(item){$http.post("/ajax/archive/"+item.id+"/discard").then(function(response){response&&1==response.data.success&&(item.discarded=1,$rootScope.update_archive_stats())})},$scope.show_feedback=function(item){$scope.modal_info=item,$("#modal-display-feedback").modal("show")}}),app.controller("ArchiveFormController",function($rootScope,$scope,$window,$location,$routeParams,$http,$breadcrumbs){$breadcrumbs.reset(),$breadcrumbs.segment("Koesuoritukset","#/archive/"),$breadcrumbs.title("Koepalautteen lähetys"),$http.get("/ajax/archive/"+$routeParams.id).then(function(response){response&&($scope.data={archive:response.data.data,validation:response.data.validation,user:response.data.user,test:response.data.test,course:response.data.test.course,indexed_answers:response.data.indexed_answers},$breadcrumbs.segment("Koepalautteen lähetys"),$scope.feedback=$scope.data.archive.feedback||{},$scope.loaded=!0)}),$scope.submit=function(){$scope.processing=!0,$http.put("/ajax/archive/"+$routeParams.id,{feedback:$scope.feedback}).then(function(response){$scope.processing=!1,$scope.save_success=!0,1==response.data.success?($rootScope.archiveFeedbackSent=!0,$rootScope.update_archive_stats(),$location.path("/archive/")):0==response.data.success&&($scope.save_success=!1,$scope.errors=response.data.errors)},function(response){$scope.save_success=!1,$scope.errors=["<b>"+response.status+"</b> "+response.statusText],$scope.processing=!1})}}),app.filter("coursefilter",function(){return function(list,settings){var out=[];return angular.forEach(list,function(value,key){(void 0===settings.published||settings.published==value.published||0==settings.published&&0==value.tests.length)&&out.push(value)}),out}}),app.controller("CoursesController",function($scope,$window,$location,$routeParams,$breadcrumbs,$sce,CoursesModel){$breadcrumbs.reset(),$breadcrumbs.segment("Kurssit"),$breadcrumbs.title("Kurssit"),$scope.courseFilter={},$scope.modal_info=!1,$scope["delete"]=function(course){$scope.modal_info={course:course},$("#modal-delete-confirmation").modal("show")},$scope.confirmed_delete=function(){$scope.modal_info!==!1&&(CoursesModel["delete"]({id:$scope.modal_info.course.id}),$scope.processing=!0,CoursesModel.query(function(data){$scope.courses=data,$scope.processing=!1,$("#modal-delete-confirmation").modal("hide"),$scope.modal_info=!1}))},$scope.loaded=!1,$scope.courses=CoursesModel.query(function(data){$scope.loaded=!0}),$scope.sortableOptions={axis:"y"}}),app.controller("CourseShowController",function($scope,$window,$location,$routeParams,$http,$breadcrumbs,CoursesModel,TestsModel){$breadcrumbs.reset(),$breadcrumbs.segment("Kurssit","#/courses/"),$breadcrumbs.title("Kurssi"),$scope.id=$routeParams.id,$scope.modal_info=!1,$scope["delete"]=function(test){$scope.modal_info={test:test},$("#modal-delete-confirmation").modal("show")},$scope.confirmed_delete=function(){$scope.modal_info!==!1&&(TestsModel["delete"]({id:$scope.modal_info.test.id}),$scope.processing=!0,CoursesModel.get({id:$scope.id},function(data){$scope.course=data,$scope.processing=!1,$("#modal-delete-confirmation").modal("hide"),$scope.modal_info=!1}))},CoursesModel.get({id:$scope.id},function(data){$scope.course=data,$scope.loaded=!0,$breadcrumbs.segment(function(){return"Kurssi: "+$scope.course.title},null,function(){return $scope.loaded}),$breadcrumbs.title(function(){return"Kurssi: "+$scope.course.title})},function(data){404==data.status&&$location.path("/tests").search({error:404})}),$scope.sortableOptions={axis:"y"}}),app.controller("CoursesFormController",function($rootScope,$scope,$window,$location,$routeParams,$http,$breadcrumbs,CoursesModel){$breadcrumbs.reset(),$breadcrumbs.segment("Kurssit","#/courses/"),$scope.id=$routeParams.id,$scope.id?$breadcrumbs.title("Muokataan kurssia"):$breadcrumbs.title("Uusi kurssi"),$scope.data={},$scope.editor_options={language:"fi",autoGrow_minHeight:200,autoGrow_maxHeight:350,autoGrow_bottomSpace:50},$scope.activeTab=1,$scope.setActiveTab=function(index){$scope.activeTab=index},$scope.id?(CoursesModel.get({id:$scope.id},function(data){$scope.data.course=data,$scope.loaded=!0,$breadcrumbs.segment("Muokataan kurssia"),$breadcrumbs.title("Muokataan kurssia "+$scope.data.course.title)},function(data){404==data.status&&$location.path("/courses").search({error:404})}),$scope.sortableOptions={axis:"y"}):($scope.data.course=new CoursesModel,$scope.data.course.published=0,$scope.loaded=!0,$breadcrumbs.segment("Uusi kurssi")),$scope.submit=function(data){$scope.processing=!0;var do_submit=function(){$scope.edit_data=!1,$scope.save_success=!1,$scope.id?$scope.data.course=CoursesModel.update({id:$scope.id},$scope.data.course,function(data,h){$scope.processing=!1,$scope.data.errors=data.errors,void 0!==data.course_edited&&($scope.save_success=!0)},function(data){popError(data.data),$scope.processing=!1}):$scope.data.course.$save(function(data,h){$scope.processing=!1,$scope.data.errors=data.errors,data.course_created&&$location.path("/tests/new/"+data.course_created)},function(data){popError(data.data),$scope.processing=!1})};$http.get("/ajax/auth").then(function(response){response.data.authenticated?do_submit():$rootScope.promptLogin(!0,function(){do_submit()})})}}),app.controller("FilesController",function($rootScope,$scope,$window,$location,$routeParams,$breadcrumbs){$breadcrumbs.reset(),$breadcrumbs.segment("Tiedostonhallinta"),$breadcrumbs.title("Tiedostonhallinta"),$scope.loaded=!1,$scope.file_type="images",$scope.setFileType=function(type){type!=$scope.file_type&&($scope.loaded=!1,$scope.file_type=type)},$scope.kcfinderLoaded=function(){$scope.$apply(function(){$scope.loaded=!0})}}),app.controller("GroupsController",function($scope,$window,$location,$routeParams,$breadcrumbs,authorization,GroupsModel,UsersModel){$breadcrumbs.reset(),$breadcrumbs.segment("Ryhmät"),$breadcrumbs.title("Ryhmät"),$scope.filter={},$scope.groups=GroupsModel.query(function(data){$scope.loaded=!0}),$scope.modal_info=!1,$scope.showGroupUsers=function(group){$scope.modal_info={group:group},$("#modal-group-students").modal("show")},$scope["delete"]=function(group){$scope.modal_info={group:group},$("#modal-delete-confirmation").modal("show")},$scope.confirmed_delete=function(){angular.forEach($scope.groups,function(value,key){value.id==$scope.modal_info.group.id&&$scope.groups.splice(key,1)}),GroupsModel["delete"]({id:$scope.modal_info.group.id}),$scope.modal_info=!1,$("#modal-delete-confirmation").modal("hide")}}),app.controller("GroupsFormController",function($rootScope,$scope,$window,$location,$filter,$routeParams,$breadcrumbs,$http,GroupsModel,UsersModel,authorization){$breadcrumbs.reset(),$breadcrumbs.segment("Ryhmät","#/groups/"),$scope.id=$routeParams.id,$scope.id?$breadcrumbs.title("Muokataan ryhmää"):$breadcrumbs.title("Uusi ryhmä"),$scope.data={},$scope.group_teacher=null,UsersModel.query(function(data){$scope.users=$filter("filter")(data,{access_level:"!USER"}),angular.forEach($scope.users,function(value,key){value.id==authorization.user.id&&($scope.group_teacher=value)})}),$scope.group_teacher_change=function(){$scope.data.group.teacher_id=$scope.group_teacher.id},$scope.id?GroupsModel.get({id:$routeParams.id},function(data){$scope.data.group=data,$scope.loaded=!0,$breadcrumbs.title("Muokataan ryhmää "+$scope.data.group.title),$breadcrumbs.segment("Muokataan ryhmää"),angular.forEach($scope.users,function(value,key){value.id==$scope.data.group.teacher_id&&($scope.group_teacher=value)})}):($scope.data.group=new GroupsModel,$scope.loaded=!0,$breadcrumbs.segment("Uusi ryhmä")),$scope.submit=function(data){$scope.processing=!0;var do_submit=function(){$scope.save_success=!1,$scope.id?$scope.data.group=GroupsModel.update({id:$scope.id},$scope.data.group,function(data){$scope.processing=!1,$scope.data.errors=data.errors,void 0!==data.group_edited&&($scope.save_success=!0)},function(data){popError(data.data),$scope.processing=!1}):$scope.data.group.$save(function(data,h){$scope.processing=!1,$scope.data.errors=data.errors,data.group_created&&$location.path("/groups/")},function(data){popError(data.data),$scope.processing=!1})};$http.get("/ajax/auth").then(function(response){response.data.authenticated?do_submit():$rootScope.promptLogin(!0,function(){do_submit()})})}}),app.controller("IndexController",function($scope,$window,$location,$routeParams,$http,$breadcrumbs){$breadcrumbs.reset(),$http.get("/ajax/recent").then(function(response){$scope.recent=response.data,angular.forEach($scope.recent.tests,function(value,key){value.updated_at=convertToDate(value.updated_at)}),angular.forEach($scope.recent.courses,function(value,key){value.updated_at=convertToDate(value.updated_at)}),$scope.loaded=!0},function(response){console.log("error",response)})}),app.controller("TestsController",function($scope,$window,$location,$routeParams,$breadcrumbs,TestsModel){$breadcrumbs.reset(),$breadcrumbs.segment("Kokeet"),$breadcrumbs.title("Kokeet"),$scope.routeError=$routeParams.error,$scope.tests=TestsModel.query(function(data){})}),app.controller("TestsFormController",function($rootScope,$scope,$window,$location,$routeParams,$q,$http,$breadcrumbs,CoursesModel,TestsModel){$scope.num_max_questions=25,$scope.id=$routeParams.id,$scope.edit_data=!1,$scope.question_types=["CHOICE","MULTI","TEXT","MULTITEXT","TEXTAREA"],$breadcrumbs.reset(),$breadcrumbs.segment("Kurssit","#/courses/"),$breadcrumbs.segment(function(){return $scope.loaded&&$scope.data.test.course?"Kurssi: "+$scope.data.test.course.title:""},function(){return $scope.loaded&&$scope.data.test.course?"#/courses/"+$scope.data.test.course.id:""},function(){return $scope.loaded&&$scope.courses_loaded}),$scope.id?$breadcrumbs.title("Muokataan koetta"):$breadcrumbs.title("Uusi koe"),$scope.activeTab=3,$scope.setActiveTab=function(index){$scope.activeTab=index},$scope.isSorting=!1,$scope.startSorting=function(){$scope.isSorting=!0,$scope.edit_data=!1,$scope.setActiveTab(2)},$scope.stopSorting=function(){$scope.isSorting=!1,$scope.edit_data=!1},$scope.sortableOptions={axis:"y"},$scope.editor_options={language:"fi",autoGrow_minHeight:350,autoGrow_maxHeight:500,autoGrow_bottomSpace:50},$scope.description_editor_options={language:"fi",autoGrow_minHeight:150,autoGrow_maxHeight:300,autoGrow_bottomSpace:20},$scope.test_material="",$scope.translate_type=translate_type,$scope.data={},$scope.selected_course=void 0,$scope.select_course=function(course_id){angular.forEach($scope.data.courses,function(value,key){return value.id==course_id?($scope.selected_course=value,!1):void 0}),$scope.update_course_selection($scope.selected_course)},$scope.update_course_selection=function(new_value){$scope.data.test.course=new_value};var query_courses=function(callback){CoursesModel.query(function(data){$scope.data.courses=data,$scope.select_course($scope.course_id),$scope.courses_loaded=!0,$scope.loaded=!0,callback&&callback()})};$scope.id?TestsModel.get({id:$scope.id},function(data){$scope.data.test=data,$scope.course_id=$scope.data.test.course.id,query_courses(function(){$breadcrumbs.segment("Muokataan koetta"),
$breadcrumbs.title("Muokataan koetta "+$scope.data.test.title)})},function(data){404==data.status&&$location.path("/tests").search({error:404})}):($scope.data.test=new TestsModel,$scope.data.test.autodiscard=0,$scope.data.test.questions=[],$scope.course_id=parseInt($routeParams.course_id),query_courses(function(){$breadcrumbs.segment("Uusi koe")}),$("#test-title").focus()),$scope.submit=function(data){$scope.processing=!0;var do_submit=function(){$scope.edit_data=!1,$scope.save_success=!1,$scope.id?$scope.data.test=TestsModel.update({id:$scope.id},$scope.data.test,function(data,h){$scope.processing=!1,$scope.data.errors=data.errors,void 0!==data.test_edited&&($scope.save_success=!0)},function(data){popError(data.data),$scope.processing=!1}):$scope.data.test.$save(function(data,h){$scope.processing=!1,$scope.data.errors=data.errors,data.test_created&&$location.path("/tests/"+data.test_created+"/edit")},function(data){popError(data.data),$scope.processing=!1})};$http.get("/ajax/auth").then(function(response){response.data.authenticated?do_submit():$rootScope.promptLogin(!0,function(){do_submit()})})},$scope.edit=function(key){$scope.edit_data!==!1&&$scope.cancel(),$scope.edit_data={key:key,copy:angular.copy($scope.data.test.questions[key])},setTimeout(function(){$("html, body").stop().delay(50).animate({scrollTop:$("#question-"+key).position().top},400),$("#question-"+key+" .question-title").select()},20)},$scope.accept=function(key){$scope.edit_data=!1},$scope.confirmed_cancel=function(){$scope.cancel(),$scope.edit($scope.modal_info.newKey),$scope.modal_info=!1,$("#modal-cancel-confirmation").modal("hide")},$scope.cancel=function(){$(".question.active").removeClass("active"),$scope.add_answer.text="",$scope.edit_data&&$scope.edit_data.copy&&($scope.data.test.questions[$scope.edit_data.key]=angular.copy($scope.edit_data.copy)),$scope.edit_data=!1},$scope["delete"]=function(key,id){var question=$scope.data.test.questions[key];$scope.modal_info={key:key,question:question},$("#modal-delete-confirmation").modal("show")},$scope.confirmed_delete=function(){$scope.modal_info&&$scope.modal_info!==!1&&($scope.data.test.questions.splice($scope.modal_info.key,1),$scope.modal_info=!1,$("#modal-delete-confirmation").modal("hide"))},$scope.add_question=function(){$scope.setActiveTab(2),$scope.data.test.questions.push({type:"CHOICE",title:"Uusi kysymys",subtitle:"",correct_answer:0,answers:[{text:"",is_correct:!0},{text:"",is_correct:!1}]});var key=$scope.data.test.questions.length-1;$scope.data.test.questions[key].order=key+1,$scope.data.errors&&$scope.data.errors.fields.add_questions&&($scope.data.errors.fields.add_questions=!1),$scope.edit(key),$("#question-"+key).addClass("active")},$scope.changing_type=function(question,newType){switch(newType){case"CHOICE":case"MULTI":case"MULTITEXT":if(question.answers.length<2)for(var i=0;i<2-question.answers.length;++i)question.answers.push({text:""})}},$scope.add_answer={"do":function(key){var text=$scope.add_answer.text.trim();text.length>0&&$scope.data.test.questions[key].answers.push({text:text}),$scope.add_answer.text=""},text:""},$scope.remove_answer=function(qkey,ckey){$scope.data.test.questions[qkey].answers.splice(ckey,1)}}),app.controller("UsersController",function($scope,$window,$location,$routeParams,$breadcrumbs,UsersModel){$breadcrumbs.reset(),$breadcrumbs.segment("Käyttäjät"),$breadcrumbs.title("Käyttäjät"),$scope.usersFilter={accessLevel:void 0},$scope.users=UsersModel.query(function(data){$scope.loaded=!0}),$scope.modal_info=!1,$scope["delete"]=function(user){$scope.modal_info={user:user},$("#modal-delete-confirmation").modal("show")},$scope.confirmed_delete=function(){angular.forEach($scope.users,function(value,key){value.id==$scope.modal_info.user.id&&$scope.users.splice(key,1)}),UsersModel["delete"]({id:$scope.modal_info.user.id}),$scope.modal_info=!1,$("#modal-delete-confirmation").modal("hide")}}),app.controller("UsersFormController",function($rootScope,$scope,$window,$location,$routeParams,$breadcrumbs,$http,UsersModel){$breadcrumbs.reset(),$breadcrumbs.segment("Käyttäjät","#/users/"),$scope.id=$routeParams.id,$scope.id?$breadcrumbs.title("Muokataan käyttäjää"):$breadcrumbs.title("Uusi käyttäjä"),$scope.data={},$scope.access_levels={USER:{level:"USER",description:"Tavallinen käyttäjä (voi vastata kokeisiin)"},TEACHER:{level:"TEACHER",description:"Opettaja (voi tarkistaa kokeiden suorituksia)"},ADMIN:{level:"ADMIN",description:"Ylläpitäjä (voi luoda ja muokata kokeita, hallita käyttäjiä)"}},$scope.access_level_change=function(){$scope.data.user.access_level=$scope.access_level.level},$scope.id?UsersModel.get({id:$routeParams.id},function(data){$scope.data.user=data,$scope.loaded=!0,$scope.access_level=$scope.access_levels[$scope.data.user.access_level],$breadcrumbs.title("Muokataan käyttäjää "+$scope.data.user.name),$breadcrumbs.segment("Muokataan käyttäjää")}):($scope.data.user=new UsersModel,$scope.loaded=!0,$scope.access_level=$scope.access_levels[0],$breadcrumbs.segment("Uusi käyttäjä")),$scope.submit=function(data){$scope.processing=!0;var do_submit=function(){$scope.save_success=!1,$scope.id?$scope.data.user=UsersModel.update({id:$scope.id},$scope.data.user,function(data,h){$scope.processing=!1,$scope.data.errors=data.errors,$scope.data.user.id==$rootScope.userData.user.id&&$rootScope.updateUserData(),void 0!==data.user_edited&&($scope.save_success=!0,$scope.data.user.password="",$scope.data.user.password_confirmation="")},function(data){popError(data.data),$scope.processing=!1}):$scope.data.user.$save(function(data,h){$scope.processing=!1,$scope.data.errors=data.errors,data.user_created&&$location.path("/users/")},function(data){popError(data.data),$scope.processing=!1})};$http.get("/ajax/auth").then(function(response){response.data.authenticated?do_submit():$rootScope.promptLogin(!0,function(){do_submit()})})}}),app.factory("QuestionsModel",function($resource){return $resource("/ajax/questions/:id",{id:"@_id"},{get:{method:"GET"},"new":{method:"POST"},update:{method:"PUT"}})}),app.factory("CoursesModel",function($resource){return $resource("/ajax/courses/:id",{id:"@_id"},{get:{method:"GET"},update:{method:"PUT"}})}),app.factory("TestsModel",function($resource){return $resource("/ajax/tests/:id",{id:"@_id"},{get:{method:"GET"},update:{method:"PUT"},"delete":{method:"DELETE"}})}),app.factory("UsersModel",function($resource){return $resource("/ajax/users/:id",{id:"@_id"},{get:{method:"GET"},update:{method:"PUT"}})}),app.factory("GroupsModel",function($resource){return $resource("/ajax/groups/:id",{id:"@_id"},{get:{method:"GET"},update:{method:"PUT"}})}),app.factory("ArchiveModel",function($resource){return $resource("/ajax/archive/:id",{id:"@_id"},{get:{method:"GET"},update:{method:"PUT"}})});